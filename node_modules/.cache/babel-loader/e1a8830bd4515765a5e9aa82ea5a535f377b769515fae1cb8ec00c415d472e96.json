{"ast":null,"code":"import Container from\"../atoms/Container\";import ProductGrid from\"../organisms/ProductGrid\";import{useEffect,useRef,useState}from\"react\";import{fetchProducts}from\"../../services/api/product\";import{useQuery}from\"react-query\";import _ from\"lodash\";import ErrorTypo from\"../atoms/ErrorTypo\";import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const MainProductTemplate=()=>{const[page,setPage]=useState(0);const isFirstLoad=useRef(true);const bottomObserver=useRef(null);const[products,setProducts]=useState([]);const[isEnd,setIsEnd]=useState(false);const{data,error,isLoading}=useQuery(`/products?page=${page}`,()=>fetchProducts(page));useEffect(()=>{const io=new IntersectionObserver(entries=>{entries.forEach(entry=>{if(entry.isIntersecting&&!isEnd){setPage(page=>page+1);}});},{root:null,threshold:1});const currentObserver=bottomObserver.current;if(currentObserver&&!isFirstLoad.current&&!isLoading){io.observe(currentObserver);}return()=>{if(currentObserver){io.unobserve(currentObserver);}};},[isLoading,isEnd]);const MAX_RESPONSE_COUNT=9;useEffect(()=>{var _data$data;if(!isLoading&&data!==null&&data!==void 0&&(_data$data=data.data)!==null&&_data$data!==void 0&&_data$data.response){setProducts(prevProducts=>_.uniqBy([...prevProducts,...data.data.response],\"id\"));if(data.data.response.length<MAX_RESPONSE_COUNT)setIsEnd(true);}},[data,isLoading,MAX_RESPONSE_COUNT]);useEffect(()=>{isFirstLoad.current=false;},[]);if(error){return/*#__PURE__*/_jsx(ErrorTypo,{});}return/*#__PURE__*/_jsxs(Container,{className:\"w-full px-24 py-16 m-auto\",children:[/*#__PURE__*/_jsx(ProductGrid,{products:products||[],isLoading:isLoading}),/*#__PURE__*/_jsx(\"div\",{ref:bottomObserver})]});};export default MainProductTemplate;","map":{"version":3,"names":["Container","ProductGrid","useEffect","useRef","useState","fetchProducts","useQuery","_","ErrorTypo","jsx","_jsx","jsxs","_jsxs","MainProductTemplate","page","setPage","isFirstLoad","bottomObserver","products","setProducts","isEnd","setIsEnd","data","error","isLoading","io","IntersectionObserver","entries","forEach","entry","isIntersecting","root","threshold","currentObserver","current","observe","unobserve","MAX_RESPONSE_COUNT","_data$data","response","prevProducts","uniqBy","length","className","children","ref"],"sources":["/Users/master/Desktop/coupon-project/kakaoshop-FE/src/components/templates/MainProductTemplate.jsx"],"sourcesContent":["import Container from \"../atoms/Container\";\nimport ProductGrid from \"../organisms/ProductGrid\";\nimport { useEffect, useRef, useState } from \"react\";\nimport { fetchProducts } from \"../../services/api/product\";\nimport { useQuery } from \"react-query\";\nimport _ from \"lodash\";\nimport ErrorTypo from \"../atoms/ErrorTypo\";\n\nconst MainProductTemplate = () => {\n  const [page, setPage] = useState(0);\n  const isFirstLoad = useRef(true);\n  const bottomObserver = useRef(null);\n  const [products, setProducts] = useState([]);\n  const [isEnd, setIsEnd] = useState(false);\n\n  const { data, error, isLoading } = useQuery(`/products?page=${page}`, () =>\n    fetchProducts(page)\n  );\n\n  useEffect(() => {\n    const io = new IntersectionObserver(\n      (entries) => {\n        entries.forEach((entry) => {\n          if (entry.isIntersecting && !isEnd) {\n            setPage((page) => page + 1);\n          }\n        });\n      },\n      {\n        root: null,\n        threshold: 1,\n      }\n    );\n\n    const currentObserver = bottomObserver.current;\n    if (currentObserver && !isFirstLoad.current && !isLoading) {\n      io.observe(currentObserver);\n    }\n\n    return () => {\n      if (currentObserver) {\n        io.unobserve(currentObserver);\n      }\n    };\n  }, [isLoading, isEnd]);\n\n  const MAX_RESPONSE_COUNT = 9;\n  useEffect(() => {\n    if (!isLoading && data?.data?.response) {\n      setProducts((prevProducts) =>\n        _.uniqBy([...prevProducts, ...data.data.response], \"id\")\n      );\n      if (data.data.response.length < MAX_RESPONSE_COUNT) setIsEnd(true);\n    }\n  }, [data, isLoading, MAX_RESPONSE_COUNT]);\n\n  useEffect(() => {\n    isFirstLoad.current = false;\n  }, []);\n\n  if (error) {\n    return <ErrorTypo />;\n  }\n  return (\n    <Container className=\"w-full px-24 py-16 m-auto\">\n      <ProductGrid products={products || []} isLoading={isLoading} />\n      <div ref={bottomObserver}></div>\n    </Container>\n  );\n};\n\nexport default MainProductTemplate;\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}